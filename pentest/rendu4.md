# TP 4 : Metasploit

## EternalBlue

Ici, nous avons à faire avec une machine windows 7, vulnérable à EternalBlue.

La premiere ligne du screenshot qui suit sert à écouter sur notre interface local, là où le meterpreter va bind.

La 2eme ligne, c'est l'ip de la machne que l'on souhaite attaquer.

Enfin la commande run sert à lancé notre exploit


![](https://i.imgur.com/7RY2fIg.png)

Ici on voit que l'on obtient un meterpreter, qui est un shell + avancé qu'un simple powershell, il permet de faire enormement de chose et notamment de téléchargé les identifiants présent sur la machine avec la commande `creds_all`

MIMIKATZ : 
![](https://i.imgur.com/Wey5V4t.png)


## MsfVenom

Msfvenom est un outil qui nous permet de générer des executables malicieux pour obtenir un meterpreter lorsque la victime vient l'ouvrir.

On va venir générer un payload et l'encodé avec shikata_na_gai

![](https://i.imgur.com/OiWJKQx.png)

Ensuite il va falloir que l'on lance un "handler" c'est un outil qui va nous servir à attendre que la victime lance l'executable.

![](https://i.imgur.com/6g7wZsr.png)

Ensuite lorsque la victime vient lancer l'executable, voila ce que l'on obtient
![](https://i.imgur.com/6euxb9Q.png)

On obtient bien un meterpreter. Microsoft defender n'a pas détécté notre payload grace à l'encodage de shikata_na_gai.

Enfin après avoir eu un shell sur la machine, nous ne sommes pas `NT AUTHORITY_SYSTEM` (le compte le plus élévé sur une machine windows) donc nous ne pouvais lancer lancer la commandes creds_all. 
Pour se faire, Metasploit et plutot bien fait puisqu'il permet de faire une escalation des privilèges et de passer `NT AUTHORITY_SYSTEM` grâce à la commande getsystem.

![](https://i.imgur.com/LRVYl1i.png)


## Encodage plus sofistiqué

Aujourd'hui les antivirus et les EDR/XDR sont bien conçu, (lol). Il existe des outils qui permettent d'executer des payloads meme avec un defender bien à jour. Ici nous allons utilisé mortar.

Voila ce que nous allons faire  : 
 1. Crétion d'un executable avec msfvenom
 2. Encodage avec mortar
 3. Envoie & execution sur la machine venir

Création de notre payload

![](https://i.imgur.com/p0goC4U.png)

Malheuresment je ne vous montrerai pas en détail comment j'ai encodé le binaire avec mortar (sort du contexte scolaire).

Ensuite on lance un handler
![](https://i.imgur.com/RQyKcvV.png)

Puis on start notre petit .bat sur la machine de la victime.
Et voila ce que l'on obtient ! 

![](https://i.imgur.com/jDdwBcQ.png)

Et voila